{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <!-- Header Section -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-chart-line me-2"></i>Health Dashboard</h2>
                <p class="text-muted mb-0">Track your health data and get AI-powered insights to improve your well-being.</p>
            </div>
            <div>
                {% if preferences and preferences.samsung_health_connected %}
                    <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Wearable Device Connected</span>
                {% else %}
                    <a href="{{ url_for('main.user_preferences') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-link me-1"></i>Connect Wearable Device
                    </a>
                {% endif %}
            </div>
        </div>
        
        <!-- Health Score Card -->
        {% if health_score is defined %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-heartbeat me-2 text-danger"></i>Health Score</h5>
                <small class="text-muted">Updated {{ health_score.updated_at.strftime('%Y-%m-%d %H:%M') if health_score.updated_at else 'Never' }}</small>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <div class="health-score-circle">
                            <h2 class="display-4 mb-0 
                                {% if health_score >= 80 %}text-success
                                {% elif health_score >= 60 %}text-warning
                                {% else %}text-danger{% endif %}">
                                {{ health_score }}
                            </h2>
                            <small class="text-muted">Overall Score</small>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label small">Activity Level</label>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             style="width: {{ activity_score or 50 }}%" 
                                             aria-valuenow="{{ activity_score or 50 }}" 
                                             aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-muted">{{ activity_score or 50 }}/100</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small">Sleep Quality</label>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-info" role="progressbar" 
                                             style="width: {{ sleep_score or 50 }}%" 
                                             aria-valuenow="{{ sleep_score or 50 }}" 
                                             aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-muted">{{ sleep_score or 50 }}/100</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label small">Nutrition</label>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-warning" role="progressbar" 
                                             style="width: {{ nutrition_score or 50 }}%" 
                                             aria-valuenow="{{ nutrition_score or 50 }}" 
                                             aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-muted">{{ nutrition_score or 50 }}/100</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small">Hydration</label>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-primary" role="progressbar" 
                                             style="width: {{ hydration_score or 50 }}%" 
                                             aria-valuenow="{{ hydration_score or 50 }}" 
                                             aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-muted">{{ hydration_score or 50 }}/100</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Today's Goals Progress -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-target me-2 text-primary"></i>Today's Goals</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 text-center mb-3">
                        <div class="goal-progress">
                            <i class="fas fa-tint fa-2x text-primary mb-2"></i>
                            <h4>{{ water_consumed or 0 }}/{{ water_goal or 2 }}L</h4>
                            <div class="progress mb-2">
                                {% set water_percentage = ((water_consumed or 0) / (water_goal or 2) * 100) | round %}
                                <div class="progress-bar bg-primary" style="width: {{ [water_percentage, 100] | min }}%"></div>
                            </div>
                            <small class="text-muted">Water Intake</small>
                        </div>
                    </div>
                    <div class="col-md-4 text-center mb-3">
                        <div class="goal-progress">
                            <i class="fas fa-walking fa-2x text-success mb-2"></i>
                            <h4>{{ steps_taken or 0 }}/{{ steps_goal or 10000 }}</h4>
                            <div class="progress mb-2">
                                {% set steps_percentage = ((steps_taken or 0) / (steps_goal or 10000) * 100) | round %}
                                <div class="progress-bar bg-success" style="width: {{ [steps_percentage, 100] | min }}%"></div>
                            </div>
                            <small class="text-muted">Steps</small>
                        </div>
                    </div>
                    <div class="col-md-4 text-center mb-3">
                        <div class="goal-progress">
                            <i class="fas fa-bed fa-2x text-info mb-2"></i>
                            <h4>{{ sleep_hours or 0 }}/{{ sleep_goal or 8 }}h</h4>
                            <div class="progress mb-2">
                                {% set sleep_percentage = ((sleep_hours or 0) / (sleep_goal or 8) * 100) | round %}
                                <div class="progress-bar bg-info" style="width: {{ [sleep_percentage, 100] | min }}%"></div>
                            </div>
                            <small class="text-muted">Sleep</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Health Data -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2 text-secondary"></i>Recent Health Data</h5>
                <a href="{{ url_for('main.log_data') }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus me-1"></i>Log Data
                </a>
            </div>
            <div class="card-body">
                {% if health_data %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Sleep (hrs)</th>
                                    <th>Water (glasses)</th>
                                    <th>Activity (1-10)</th>
                                    <th>Steps</th>
                                    <th>Heart Rate</th>
                                    <th>Mood (1-10)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for data in health_data[:10] %}
                                <tr>
                                    <td>{{ data.date_logged.strftime('%m/%d') }}</td>
                                    <td>
                                        {% if data.sleep_duration_hours %}
                                            <i class="fas fa-bed text-info me-1"></i>{{ data.sleep_duration_hours }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if data.water_intake_liters %}
                                            <i class="fas fa-tint text-primary me-1"></i>{{ data.water_intake_liters }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if data.active_minutes %}
                                            <i class="fas fa-dumbbell text-success me-1"></i>{{ data.active_minutes }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if data.steps_count %}
                                            <i class="fas fa-walking text-warning me-1"></i>{{ data.steps_count }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if data.heart_rate %}
                                            <i class="fas fa-heartbeat text-danger me-1"></i>{{ data.heart_rate }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if data.mood_score %}
                                            {% if data.mood_score >= 8 %}
                                                <i class="fas fa-smile text-success me-1"></i>{{ data.mood_score }}
                                            {% elif data.mood_score >= 5 %}
                                                <i class="fas fa-meh text-warning me-1"></i>{{ data.mood_score }}
                                            {% else %}
                                                <i class="fas fa-frown text-danger me-1"></i>{{ data.mood_score }}
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No health data logged yet. Start tracking your health metrics!</p>
                        <a href="{{ url_for('main.log_data') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>Log Your First Entry
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Comprehensive Health Metrics (Collapsible) -->
        {% if health_data %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <button class="btn btn-link text-decoration-none p-0 w-100 text-start d-flex justify-content-between align-items-center" 
                            type="button" data-bs-toggle="collapse" data-bs-target="#comprehensiveMetrics" 
                            aria-expanded="false" aria-controls="comprehensiveMetrics">
                        <span><i class="fas fa-chart-line me-2 text-info"></i>Comprehensive Health Metrics</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </h5>
            </div>
            <div class="collapse" id="comprehensiveMetrics">
                <div class="card-body">
                    <div class="row">
                        <!-- Activity Metrics Column -->
                        <div class="col-md-6 col-lg-4 mb-4">
                            <h6 class="text-success border-bottom pb-2"><i class="fas fa-running me-1"></i>Activity Metrics</h6>
                            {% if health_data and health_data|length > 0 %}
                                {% set latest = health_data[0] %}
                                <div class="metric-item mb-2">
                                    <small class="text-muted">Steps:</small>
                                    <span class="fw-bold">{{ latest.steps or 'N/A' }}</span>
                                </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Distance:</small>
                                <span class="fw-bold">{{ latest.distance_km or 'N/A' }} km</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Active Minutes:</small>
                                <span class="fw-bold">{{ latest.active_minutes or 'N/A' }} min</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Calories Burned:</small>
                                <span class="fw-bold">{{ latest.calories_total or 'N/A' }}</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Floors Climbed:</small>
                                <span class="fw-bold">{{ latest.floors_climbed or 'N/A' }}</span>
                            </div>
                        </div>
                        
                        <!-- Heart Health Column -->
                        <div class="col-md-6 col-lg-4 mb-4">
                            <h6 class="text-danger border-bottom pb-2"><i class="fas fa-heartbeat me-1"></i>Heart Health</h6>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Resting HR:</small>
                                <span class="fw-bold">{{ latest.heart_rate_resting or 'N/A' }} BPM</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Average HR:</small>
                                <span class="fw-bold">{{ latest.heart_rate_avg or 'N/A' }} BPM</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Max HR:</small>
                                <span class="fw-bold">{{ latest.heart_rate_max or 'N/A' }} BPM</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">HRV:</small>
                                <span class="fw-bold">{{ latest.heart_rate_variability or 'N/A' }} ms</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Blood Oxygen:</small>
                                <span class="fw-bold">{{ latest.blood_oxygen_percent or 'N/A' }}%</span>
                            </div>
                        </div>
                        
                        <!-- Sleep Metrics Column -->
                        <div class="col-md-6 col-lg-4 mb-4">
                            <h6 class="text-primary border-bottom pb-2"><i class="fas fa-bed me-1"></i>Sleep Analysis</h6>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Total Sleep:</small>
                                <span class="fw-bold">{{ latest.sleep_duration_hours or 'N/A' }} hours</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Sleep Quality:</small>
                                <span class="fw-bold">{{ latest.sleep_quality_score or 'N/A' }}/100</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Deep Sleep:</small>
                                <span class="fw-bold">{{ latest.sleep_deep_minutes or 'N/A' }} min</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">REM Sleep:</small>
                                <span class="fw-bold">{{ latest.sleep_rem_minutes or 'N/A' }} min</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Light Sleep:</small>
                                <span class="fw-bold">{{ latest.sleep_light_minutes or 'N/A' }} min</span>
                            </div>
                        </div>
                        
                        <!-- Body Composition -->
                        <div class="col-md-6 col-lg-4 mb-4">
                            <h6 class="text-warning border-bottom pb-2"><i class="fas fa-weight me-1"></i>Body Composition</h6>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Weight:</small>
                                <span class="fw-bold">{{ latest.weight_kg or 'N/A' }} kg</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Body Fat:</small>
                                <span class="fw-bold">{{ latest.body_fat_percent or 'N/A' }}%</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Muscle Mass:</small>
                                <span class="fw-bold">{{ latest.muscle_mass_kg or 'N/A' }} kg</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Body Temp:</small>
                                <span class="fw-bold">{{ latest.body_temperature or 'N/A' }}Â°C</span>
                            </div>
                        </div>
                        
                        <!-- Wellness Metrics -->
                        <div class="col-md-6 col-lg-4 mb-4">
                            <h6 class="text-info border-bottom pb-2"><i class="fas fa-smile me-1"></i>Wellness</h6>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Water Intake:</small>
                                <span class="fw-bold">{{ latest.water_intake_liters or 'N/A' }} L</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Mood Score:</small>
                                <span class="fw-bold">{{ latest.mood_score or 'N/A' }}/10</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Energy Level:</small>
                                <span class="fw-bold">{{ latest.energy_level or 'N/A' }}/10</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Stress Level:</small>
                                <span class="fw-bold">{{ latest.stress_level or 'N/A' }}/100</span>
                            </div>
                        </div>
                        
                        <!-- Workout Session -->
                        <div class="col-md-6 col-lg-4 mb-4">
                            <h6 class="text-secondary border-bottom pb-2"><i class="fas fa-dumbbell me-1"></i>Latest Workout</h6>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Type:</small>
                                <span class="fw-bold">{{ latest.workout_type.title() if latest.workout_type else 'N/A' }}</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Duration:</small>
                                <span class="fw-bold">{{ latest.workout_duration_minutes or 'N/A' }} min</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Intensity:</small>
                                <span class="fw-bold">{{ latest.workout_intensity.title() if latest.workout_intensity else 'N/A' }}</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Calories:</small>
                                <span class="fw-bold">{{ latest.workout_calories or 'N/A' }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Historical Data Toggle -->
                    <div class="mt-3">
                        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#historicalData" aria-expanded="false" aria-controls="historicalData">
                            <i class="fas fa-history me-1"></i>View Historical Data (Last 7 Days)
                        </button>
                    </div>
                    
                    <div class="collapse mt-3" id="historicalData">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Sleep</th>
                                        <th>Steps</th>
                                        <th>Water</th>
                                        <th>Mood</th>
                                        <th>Active Min</th>
                                        <th>Weight</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for data in health_data %}
                                    <tr>
                                        <td><small>{{ data.date_logged.strftime('%m/%d') }}</small></td>
                                        <td><small>{{ data.sleep_duration_hours or '-' }}h</small></td>
                                        <td><small>{{ data.steps or '-' }}</small></td>
                                        <td><small>{{ data.water_intake_liters or '-' }}L</small></td>
                                        <td><small>{{ data.mood_score or '-' }}/10</small></td>
                                        <td><small>{{ data.active_minutes or '-' }}min</small></td>
                                        <td><small>{{ data.weight_kg or '-' }}kg</small></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% else %}
                    <div class="card-body">
                        <p class="text-muted text-center">No health data available yet. <a href="{{ url_for('main.log_data') }}">Log your first entry</a> to see comprehensive metrics.</p>
                    </div>
                {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Upcoming Calendar Events -->
        {% if upcoming_events %}
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-calendar-alt me-2 text-warning"></i>Upcoming Events</h5>
                <a href="{{ url_for('main.calendar') }}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                {% for event in upcoming_events[:3] %}
                <div class="d-flex align-items-center mb-2 {% if not loop.last %}border-bottom pb-2{% endif %}">
                    <div class="me-3">
                        {% if event.event_type == 'work' %}
                            <i class="fas fa-briefcase text-primary"></i>
                        {% elif event.event_type == 'exercise' %}
                            <i class="fas fa-dumbbell text-success"></i>
                        {% elif event.event_type == 'meal' %}
                            <i class="fas fa-utensils text-warning"></i>
                        {% elif event.event_type == 'health' %}
                            <i class="fas fa-stethoscope text-info"></i>
                        {% else %}
                            <i class="fas fa-calendar text-secondary"></i>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">{{ event.title }}</div>
                        <small class="text-muted">{{ event.start_time.strftime('%Y-%m-%d %H:%M') }}</small>
                    </div>
                    <div>
                        {% if event.is_ai_modifiable %}
                            <span class="badge bg-success"><i class="fas fa-robot"></i></span>
                        {% else %}
                            <span class="badge bg-secondary"><i class="fas fa-lock"></i></span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-md-4">
        <!-- AI Recommendations -->
        {% if ai_recommendations %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-robot me-2 text-info"></i>AI Recommendations</h5>
            </div>
            <div class="card-body">
                {% for recommendation in ai_recommendations[:3] %}
                <div class="alert alert-{{ 'success' if recommendation.recommendation_type == 'positive' else 'warning' if recommendation.recommendation_type == 'improvement' else 'info' }} advice-alert py-2">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-lightbulb me-2 mt-1"></i>
                        <div>
                            <strong>{{ recommendation.recommendation_type.title() }}</strong>
                            <p class="mb-0 small">{{ recommendation.description }}</p>
                            {% if recommendation.ai_confidence %}
                            <small class="text-muted">Confidence: {{ (recommendation.ai_confidence * 100) | round }}%</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- AI-Powered Personalized Advice -->
        <div class="card mb-4" id="personalizedAdviceCard">
            <div class="card-header">
                <h5 class="mb-0">
                    <button class="btn btn-link text-decoration-none p-0 w-100 text-start d-flex justify-content-between align-items-center" 
                            type="button" data-bs-toggle="collapse" data-bs-target="#personalizedAdvice" 
                            aria-expanded="false" aria-controls="personalizedAdvice">
                        <span><i class="fas fa-brain me-2 text-success"></i>Personalized Health Advice</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </h5>
                <small class="text-muted">AI-generated insights based on your health patterns</small>
            </div>
            <div class="collapse" id="personalizedAdvice">
                <div class="card-body">
                    <!-- Loading state -->
                    <div id="adviceLoadingState" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Generating advice...</span>
                        </div>
                        <p class="mt-2 text-muted">Analyzing your health patterns...</p>
                    </div>
                    
                    <!-- Advice content -->
                    <div id="adviceContent">
                        {% if ai_advice %}
                        <!-- Existing advice content -->
                        <div id="actualAdviceContent">
                            <!-- Refresh button -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0 text-success"><i class="fas fa-sparkles me-1"></i>Your Latest Health Insights</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="generateHealthAdvice()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh Advice
                                </button>
                            </div>
                            
                            <!-- Key Insights -->
                            {% if ai_advice.insights %}
                            <div id="adviceInsights" class="mb-3">
                                <h6 class="text-primary"><i class="fas fa-eye me-1"></i>Key Insights</h6>
                                <div id="insightsContent">
                                    {% for insight in ai_advice.insights %}
                                    <div class="alert alert-info advice-alert py-2 mb-2">
                                        <small><i class="fas fa-lightbulb me-1"></i>{{ insight }}</small>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Priority Recommendations -->
                            {% if ai_advice.recommendations %}
                            <div id="adviceRecommendations" class="mb-3">
                                <h6 class="text-success"><i class="fas fa-star me-1"></i>Priority Recommendations</h6>
                                <div id="recommendationsContent">
                                    {% for recommendation in ai_advice.recommendations %}
                                    <div class="alert alert-success advice-alert py-2 mb-2">
                                        <small><i class="fas fa-arrow-right me-1"></i>{{ recommendation }}</small>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Quick Wins -->
                            {% if ai_advice.quick_wins %}
                            <div id="adviceQuickWins" class="mb-3">
                                <h6 class="text-warning"><i class="fas fa-bolt me-1"></i>Quick Wins</h6>
                                <div id="quickWinsContent">
                                    {% for quick_win in ai_advice.quick_wins %}
                                    <div class="alert alert-warning advice-alert py-2 mb-2">
                                        <small><i class="fas fa-check me-1"></i>{{ quick_win }}</small>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Areas of Concern -->
                            {% if ai_advice.concerns %}
                            <div id="adviceConcerns" class="mb-3">
                                <h6 class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Areas to Watch</h6>
                                <div id="concernsContent">
                                    {% for concern in ai_advice.concerns %}
                                    <div class="alert alert-danger advice-alert py-2 mb-2">
                                        <small><i class="fas fa-info-circle me-1"></i>{{ concern }}</small>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Motivation Message -->
                            {% if ai_advice.motivation %}
                            <div id="adviceMotivation" class="mb-3">
                                <div class="bg-light p-3 rounded">
                                    <h6 class="text-primary mb-2"><i class="fas fa-heart me-1"></i>Stay Motivated</h6>
                                    <p class="mb-0 small text-muted" id="motivationContent">{{ ai_advice.motivation }}</p>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Source Information -->
                            <div id="adviceSource" class="mt-3 pt-2 border-top">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <span id="sourceInfo">Generated by {{ 'AI Assistant' if ai_advice.source == 'gemini_ai' else 'Health Analytics' }}{% if ai_advice.generated_at %} at {{ ai_advice.generated_at[:19] | replace('T', ' ') }}{% endif %}</span>
                                    <br><em>This advice is for informational purposes and not a substitute for professional medical consultation.</em>
                                </small>
                            </div>
                        </div>
                        {% else %}
                        <!-- No advice message -->
                        <div class="text-center py-4" id="noAdviceMessage">
                            <i class="fas fa-lightbulb fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">No personalized advice generated yet</h6>
                            <p class="text-muted small mb-3">Click the button below to generate AI-powered health insights based on your recent health data.</p>
                            <button type="button" class="btn btn-primary" onclick="generateHealthAdvice()">
                                <i class="fas fa-brain me-1"></i>Generate Health Advice
                            </button>
                        </div>
                        
                        <!-- Actual advice content (initially hidden) -->
                        <div id="actualAdviceContent" style="display: none;">
                            <!-- Refresh button -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0 text-success"><i class="fas fa-sparkles me-1"></i>Your Latest Health Insights</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="generateHealthAdvice()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh Advice
                                </button>
                            </div>
                            
                            <!-- Key Insights -->
                            <div id="adviceInsights" class="mb-3" style="display: none;">
                                <h6 class="text-primary"><i class="fas fa-eye me-1"></i>Key Insights</h6>
                                <div id="insightsContent"></div>
                            </div>
                            
                            <!-- Priority Recommendations -->
                            <div id="adviceRecommendations" class="mb-3" style="display: none;">
                                <h6 class="text-success"><i class="fas fa-star me-1"></i>Priority Recommendations</h6>
                                <div id="recommendationsContent"></div>
                            </div>
                            
                            <!-- Quick Wins -->
                            <div id="adviceQuickWins" class="mb-3" style="display: none;">
                                <h6 class="text-warning"><i class="fas fa-bolt me-1"></i>Quick Wins</h6>
                                <div id="quickWinsContent"></div>
                            </div>
                            
                            <!-- Areas of Concern -->
                            <div id="adviceConcerns" class="mb-3" style="display: none;">
                                <h6 class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Areas to Watch</h6>
                                <div id="concernsContent"></div>
                            </div>
                            
                            <!-- Motivation Message -->
                            <div id="adviceMotivation" class="mb-3" style="display: none;">
                                <div class="bg-light p-3 rounded">
                                    <h6 class="text-primary mb-2"><i class="fas fa-heart me-1"></i>Stay Motivated</h6>
                                    <p class="mb-0 small text-muted" id="motivationContent"></p>
                                </div>
                            </div>
                            
                            <!-- Source Information -->
                            <div id="adviceSource" class="mt-3 pt-2 border-top" style="display: none;">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <span id="sourceInfo"></span>
                                    <br><em>This advice is for informational purposes and not a substitute for professional medical consultation.</em>
                                </small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bolt me-2 text-warning"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('main.log_data') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Log Health Data
                    </a>
                    <a href="{{ url_for('main.add_calendar_event') }}" class="btn btn-success">
                        <i class="fas fa-calendar-plus me-1"></i>Add Event
                    </a>
                    {% if preferences and preferences.ai_optimization_enabled %}
                    <button class="btn btn-info" onclick="triggerAIOptimization()">
                        <i class="fas fa-robot me-1"></i>AI Optimize Schedule
                    </button>
                    {% endif %}
                    <a href="{{ url_for('main.user_preferences') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-cog me-1"></i>Settings
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Health Streak -->
        {% if health_streak %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-fire me-2 text-danger"></i>Health Streak</h5>
            </div>
            <div class="card-body text-center">
                <h2 class="display-4 text-success">{{ health_streak.current_streak }}</h2>
                <p class="mb-1">Days of consistent health tracking</p>
                <small class="text-muted">Best streak: {{ health_streak.best_streak }} days</small>
            </div>
        </div>
        {% endif %}
        
        <!-- System Status -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2 text-info"></i>System Status</h5>
            </div>
            <div class="card-body">
                <div class="status-item d-flex justify-content-between align-items-center mb-2">
                    <span>AI Services</span>
                    <span class="badge bg-success">Active</span>
                </div>
                <div class="status-item d-flex justify-content-between align-items-center mb-2">
                    <span>Wearable Device</span>
                    <span class="badge bg-{{ 'success' if samsung_health_connected else 'secondary' }}">
                        {{ 'Connected' if samsung_health_connected else 'Disconnected' }}
                    </span>
                </div>
                <div class="status-item d-flex justify-content-between align-items-center">
                    <span>Data Sync</span>
                    <span class="badge bg-{{ 'success' if last_sync_time else 'warning' }}">
                        {{ last_sync_time.strftime('%H:%M') if last_sync_time else 'Pending' }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function triggerAIOptimization() {
    // Redirect to calendar with optimization trigger
    window.location.href = "{{ url_for('main.calendar') }}?optimize=true";
}

// Remember collapsible section states
document.addEventListener('DOMContentLoaded', function() {
    // List of collapsible sections to remember (including new advice section)
    const collapsibleSections = ['comprehensiveMetrics', 'historicalData', 'personalizedAdvice'];
    
    // Restore saved states
    collapsibleSections.forEach(function(sectionId) {
        const savedState = localStorage.getItem('dashboard_' + sectionId);
        const element = document.getElementById(sectionId);
        
        if (element && savedState === 'show') {
            // Show the section if it was previously open
            element.classList.add('show');
            // Update the chevron icon
            const button = document.querySelector('[data-bs-target="#' + sectionId + '"]');
            if (button) {
                const icon = button.querySelector('.fa-chevron-down');
                if (icon) {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                }
            }
        }
    });
    
    // Save state when sections are toggled
    collapsibleSections.forEach(function(sectionId) {
        const element = document.getElementById(sectionId);
        if (element) {
            element.addEventListener('shown.bs.collapse', function() {
                localStorage.setItem('dashboard_' + sectionId, 'show');
                // Update chevron icon
                const button = document.querySelector('[data-bs-target="#' + sectionId + '"]');
                if (button) {
                    const icon = button.querySelector('.fa-chevron-down');
                    if (icon) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    }
                }
            });
            
            element.addEventListener('hidden.bs.collapse', function() {
                localStorage.setItem('dashboard_' + sectionId, 'hide');
                // Update chevron icon
                const button = document.querySelector('[data-bs-target="#' + sectionId + '"]');
                if (button) {
                    const icon = button.querySelector('.fa-chevron-up');
                    if (icon) {
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    }
                }
            });
        }
    });
});

// Function to generate health advice via AJAX
function generateHealthAdvice() {
    // Show loading state
    document.getElementById('adviceLoadingState').style.display = 'block';
    
    // Hide existing content
    const noAdviceMessage = document.getElementById('noAdviceMessage');
    const actualAdviceContent = document.getElementById('actualAdviceContent');
    
    if (noAdviceMessage) {
        noAdviceMessage.style.display = 'none';
    }
    if (actualAdviceContent) {
        actualAdviceContent.style.display = 'none';
    }
    
    // Make AJAX request to generate advice
    fetch('{{ url_for("main.generate_personalized_advice") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Hide loading state
        document.getElementById('adviceLoadingState').style.display = 'none';
        
        if (data.success && data.ai_advice) {
            // Show advice content
            displayAdviceContent(data.ai_advice);
        } else {
            // Show error message
            showAdviceError(data.error || 'Failed to generate health advice');
        }
    })
    .catch(error => {
        console.error('Error generating advice:', error);
        document.getElementById('adviceLoadingState').style.display = 'none';
        showAdviceError('Network error occurred while generating advice');
    });
}

// Function to display advice content
function displayAdviceContent(advice) {
    // Show the actual advice content
    const actualAdviceContent = document.getElementById('actualAdviceContent');
    if (actualAdviceContent) {
        actualAdviceContent.style.display = 'block';
    }
    
    // Hide no advice message
    const noAdviceMessage = document.getElementById('noAdviceMessage');
    if (noAdviceMessage) {
        noAdviceMessage.style.display = 'none';
    }
    
    // Helper function to create alert elements for content
    function createAlertContent(content, alertClass, iconClass) {
        if (!content) return '';
        
        if (typeof content === 'string') {
            return `<div class="alert ${alertClass} advice-alert py-2 mb-2">
                        <small><i class="${iconClass} me-1"></i>${content}</small>
                    </div>`;
        } else if (Array.isArray(content)) {
            return content.filter(item => item && item.length > 0)
                         .map(item => `<div class="alert ${alertClass} advice-alert py-2 mb-2">
                                          <small><i class="${iconClass} me-1"></i>${item}</small>
                                       </div>`)
                         .join('');
        }
        return '';
    }
    
    // Display insights
    if (advice.insights) {
        const insightsContent = createAlertContent(advice.insights, 'alert-info', 'fas fa-lightbulb');
        if (insightsContent) {
            document.getElementById('insightsContent').innerHTML = insightsContent;
            document.getElementById('adviceInsights').style.display = 'block';
        }
    }
    
    // Display recommendations
    if (advice.recommendations) {
        const recommendationsContent = createAlertContent(advice.recommendations, 'alert-success', 'fas fa-arrow-right');
        if (recommendationsContent) {
            document.getElementById('recommendationsContent').innerHTML = recommendationsContent;
            document.getElementById('adviceRecommendations').style.display = 'block';
        }
    }
    
    // Display quick wins
    if (advice.quick_wins) {
        const quickWinsContent = createAlertContent(advice.quick_wins, 'alert-warning', 'fas fa-check');
        if (quickWinsContent) {
            document.getElementById('quickWinsContent').innerHTML = quickWinsContent;
            document.getElementById('adviceQuickWins').style.display = 'block';
        }
    }
    
    // Display concerns
    if (advice.concerns) {
        const concernsContent = createAlertContent(advice.concerns, 'alert-danger', 'fas fa-info-circle');
        if (concernsContent) {
            document.getElementById('concernsContent').innerHTML = concernsContent;
            document.getElementById('adviceConcerns').style.display = 'block';
        }
    }
    
    // Display motivation
    if (advice.motivation) {
        document.getElementById('motivationContent').textContent = advice.motivation;
        document.getElementById('adviceMotivation').style.display = 'block';
    }
    
    // Display source information
    if (advice.source || advice.generated_at) {
        const sourceText = `Generated by ${advice.source === 'gemini_ai' ? 'AI Assistant' : 'Health Analytics'}${advice.generated_at ? ' at ' + new Date(advice.generated_at).toLocaleString() : ''}`;
        document.getElementById('sourceInfo').textContent = sourceText;
        document.getElementById('adviceSource').style.display = 'block';
    }
}

// Function to show error message
function showAdviceError(errorMessage) {
    const noAdviceMessage = document.getElementById('noAdviceMessage');
    if (noAdviceMessage) {
        noAdviceMessage.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                <h6 class="text-warning">Unable to Generate Advice</h6>
                <p class="text-muted small mb-3">${errorMessage}</p>
                <button type="button" class="btn btn-primary" onclick="generateHealthAdvice()">
                    <i class="fas fa-redo me-1"></i>Try Again
                </button>
            </div>
        `;
        noAdviceMessage.style.display = 'block';
    }
    
    const actualAdviceContent = document.getElementById('actualAdviceContent');
    if (actualAdviceContent) {
        actualAdviceContent.style.display = 'none';
    }
}

// Auto-refresh dashboard every 5 minutes (but preserve collapse states)
setInterval(function() {
    // Only refresh if user is still active
    if (document.hasFocus()) {
        // Save current collapse states before refresh
        const collapsibleSections = ['comprehensiveMetrics', 'historicalData', 'personalizedAdvice'];
        collapsibleSections.forEach(function(sectionId) {
            const element = document.getElementById(sectionId);
            if (element && element.classList.contains('show')) {
                localStorage.setItem('dashboard_' + sectionId, 'show');
            }
        });
        location.reload();
    }
}, 300000);
</script>
{% endblock %}
