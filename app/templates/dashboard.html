{% extends "base.html" %}

{% block content %}
<style>
    /* Health Visualization Styles */
    .correlation-strength {
        width: 100%;
        height: 8px;
        background-color: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .strength-bar {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    
    .correlation-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .correlation-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    }
    
    .summary-card {
        transition: transform 0.2s ease;
    }
    
    .summary-card:hover {
        transform: scale(1.05);
    }
    
    .zone-item {
        transition: all 0.2s ease;
    }
    
    .zone-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transform: translateX(5px);
    }
    
    .hydration-goal-circle {
        animation: fadeIn 1s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.8); }
        to { opacity: 1; transform: scale(1); }
    }
    
    /* Responsive chart containers */
    canvas {
        max-width: 100%;
        height: auto !important;
    }
    
    /* Print-friendly styles */
    @media print {
        .card {
            page-break-inside: avoid;
        }
    }
</style>

<div class="row">
    <div class="col-md-8">
        <!-- Header Section -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-chart-line me-2"></i>Health Dashboard</h2>
                <p class="text-muted mb-0">Track your health data and get AI-powered insights to improve your well-being.</p>
            </div>
            <div>
                {% if preferences and preferences.samsung_health_connected %}
                    <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Wearable Device Connected</span>
                {% else %}
                    <a href="{{ url_for('main.user_preferences') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-upload me-1"></i>Upload Health Data Files
                    </a>
                {% endif %}
            </div>
        </div>
        
        <!-- Health Score Card -->
        {% if health_score is defined %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-heartbeat me-2 text-danger"></i>Health Score</h5>
                <small class="text-muted">Updated {{ health_score.updated_at.strftime('%Y-%m-%d %H:%M') if health_score.updated_at else 'Never' }}</small>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <div class="health-score-circle">
                            <h2 class="display-4 mb-0 
                                {% if health_score >= 80 %}text-success
                                {% elif health_score >= 60 %}text-warning
                                {% else %}text-danger{% endif %}">
                                {{ health_score }}
                            </h2>
                            <small class="text-muted">Overall Score</small>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label small">Activity Level</label>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             style="width: {{ activity_score or 0 }}%" 
                                             aria-valuenow="{{ activity_score or 0 }}" 
                                             aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-muted">{{ activity_score or 0 }}/100</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small">Sleep Quality</label>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-info" role="progressbar" 
                                             style="width: {{ sleep_score or 0 }}%" 
                                             aria-valuenow="{{ sleep_score or 0 }}" 
                                             aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-muted">{{ sleep_score or 0 }}/100</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label small">Nutrition</label>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-warning" role="progressbar" 
                                             style="width: {{ nutrition_score or 0 }}%" 
                                             aria-valuenow="{{ nutrition_score or 0 }}" 
                                             aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-muted">{{ nutrition_score or 0 }}/100</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small">Hydration</label>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-primary" role="progressbar" 
                                             style="width: {{ hydration_score or 0 }}%" 
                                             aria-valuenow="{{ hydration_score or 0 }}" 
                                             aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-muted">{{ hydration_score or 0 }}/100</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Today's Goals Progress -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-target me-2 text-primary"></i>Today's Goals</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 text-center mb-3">
                        <div class="goal-progress">
                            <i class="fas fa-tint fa-2x text-primary mb-2"></i>
                            <h4>{{ water_consumed or 0 }}/{{ water_goal or 2 }}L</h4>
                            <div class="progress mb-2">
                                {% set water_percentage = ((water_consumed or 0) / (water_goal or 2) * 100) | round %}
                                <div class="progress-bar bg-primary" style="width: {{ [water_percentage, 100] | min }}%"></div>
                            </div>
                            <small class="text-muted">Water Intake</small>
                        </div>
                    </div>
                    <div class="col-md-4 text-center mb-3">
                        <div class="goal-progress">
                            <i class="fas fa-walking fa-2x text-success mb-2"></i>
                            <h4>{{ steps_taken or 0 }}/{{ steps_goal or 10000 }}</h4>
                            <div class="progress mb-2">
                                {% set steps_percentage = ((steps_taken or 0) / (steps_goal or 10000) * 100) | round %}
                                <div class="progress-bar bg-success" style="width: {{ [steps_percentage, 100] | min }}%"></div>
                            </div>
                            <small class="text-muted">Steps</small>
                        </div>
                    </div>
                    <div class="col-md-4 text-center mb-3">
                        <div class="goal-progress">
                            <i class="fas fa-bed fa-2x text-info mb-2"></i>
                            <h4>{{ sleep_hours or 0 }}/{{ sleep_goal or 8 }}h</h4>
                            <div class="progress mb-2">
                                {% set sleep_percentage = ((sleep_hours or 0) / (sleep_goal or 8) * 100) | round %}
                                <div class="progress-bar bg-info" style="width: {{ [sleep_percentage, 100] | min }}%"></div>
                            </div>
                            <small class="text-muted">Sleep</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Health Data -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2 text-secondary"></i>Recent Health Data</h5>
                <a href="{{ url_for('main.log_data') }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus me-1"></i>Log Data
                </a>
            </div>
            <div class="card-body">
                {% if health_data %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Sleep (hrs)</th>
                                    <th>Water (glasses)</th>
                                    <th>Energy (1-10)</th>
                                    <th>Steps</th>
                                    <th>Heart Rate</th>
                                    <th>Mood (1-10)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for data in health_data[:10] %}
                                <tr>
                                    <td>{{ data.date_logged.strftime('%m/%d') }}</td>
                                    <td>
                                        {% if data.sleep_duration_hours %}
                                            <i class="fas fa-bed text-info me-1"></i>{{ data.sleep_duration_hours }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if data.water_intake_liters %}
                                            <i class="fas fa-tint text-primary me-1"></i>{{ data.water_intake_liters }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if data.energy_level %}
                                            <i class="fas fa-bolt text-success me-1"></i>{{ data.energy_level }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if data.steps %}
                                            <i class="fas fa-walking text-warning me-1"></i>{{ data.steps }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if data.heart_rate_avg %}
                                            <i class="fas fa-heartbeat text-danger me-1"></i>{{ data.heart_rate_avg }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if data.mood_score %}
                                            {% if data.mood_score >= 8 %}
                                                <i class="fas fa-smile text-success me-1"></i>{{ data.mood_score }}
                                            {% elif data.mood_score >= 5 %}
                                                <i class="fas fa-meh text-warning me-1"></i>{{ data.mood_score }}
                                            {% else %}
                                                <i class="fas fa-frown text-danger me-1"></i>{{ data.mood_score }}
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No health data logged yet. Start tracking your health metrics!</p>
                        <a href="{{ url_for('main.log_data') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>Log Your First Entry
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Comprehensive Health Metrics (Collapsible) -->
        {% if health_data %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <button class="btn btn-link text-decoration-none p-0 w-100 text-start d-flex justify-content-between align-items-center" 
                            type="button" data-bs-toggle="collapse" data-bs-target="#comprehensiveMetrics" 
                            aria-expanded="false" aria-controls="comprehensiveMetrics">
                        <span><i class="fas fa-chart-line me-2 text-info"></i>Comprehensive Health Metrics</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </h5>
            </div>
            <div class="collapse" id="comprehensiveMetrics">
                <div class="card-body">
                    <div class="row">
                        <!-- Activity Metrics Column -->
                        <div class="col-md-6 col-lg-4 mb-4">
                            <h6 class="text-success border-bottom pb-2"><i class="fas fa-running me-1"></i>Activity Metrics</h6>
                            {% if health_data and health_data|length > 0 %}
                                {% set latest = health_data[0] %}
                                <div class="metric-item mb-2">
                                    <small class="text-muted">Steps:</small>
                                    <span class="fw-bold">{{ latest.steps or 'N/A' }}</span>
                                </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Distance:</small>
                                <span class="fw-bold">{{ latest.distance_km or 'N/A' }} km</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Active Minutes:</small>
                                <span class="fw-bold">{{ latest.active_minutes or 'N/A' }} min</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Calories Burned:</small>
                                <span class="fw-bold">{{ latest.calories_total or 'N/A' }}</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Floors Climbed:</small>
                                <span class="fw-bold">{{ latest.floors_climbed or 'N/A' }}</span>
                            </div>
                        </div>
                        
                        <!-- Heart Health Column -->
                        <div class="col-md-6 col-lg-4 mb-4">
                            <h6 class="text-danger border-bottom pb-2"><i class="fas fa-heartbeat me-1"></i>Heart Health</h6>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Resting HR:</small>
                                <span class="fw-bold">{{ latest.heart_rate_resting or 'N/A' }} BPM</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Average HR:</small>
                                <span class="fw-bold">{{ latest.heart_rate_avg or 'N/A' }} BPM</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Max HR:</small>
                                <span class="fw-bold">{{ latest.heart_rate_max or 'N/A' }} BPM</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">HRV:</small>
                                <span class="fw-bold">{{ latest.heart_rate_variability or 'N/A' }} ms</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Blood Oxygen:</small>
                                <span class="fw-bold">{{ latest.blood_oxygen_percent or 'N/A' }}%</span>
                            </div>
                        </div>
                        
                        <!-- Sleep Metrics Column -->
                        <div class="col-md-6 col-lg-4 mb-4">
                            <h6 class="text-primary border-bottom pb-2"><i class="fas fa-bed me-1"></i>Sleep Analysis</h6>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Total Sleep:</small>
                                <span class="fw-bold">{{ latest.sleep_duration_hours or 'N/A' }} hours</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Sleep Quality:</small>
                                <span class="fw-bold">{{ latest.sleep_quality_score or 'N/A' }}/10</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Deep Sleep:</small>
                                <span class="fw-bold">{{ latest.sleep_deep_minutes or 'N/A' }} min</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">REM Sleep:</small>
                                <span class="fw-bold">{{ latest.sleep_rem_minutes or 'N/A' }} min</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Light Sleep:</small>
                                <span class="fw-bold">{{ latest.sleep_light_minutes or 'N/A' }} min</span>
                            </div>
                        </div>
                        
                        <!-- Body Composition -->
                        <div class="col-md-6 col-lg-4 mb-4">
                            <h6 class="text-warning border-bottom pb-2"><i class="fas fa-weight me-1"></i>Body Composition</h6>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Weight:</small>
                                <span class="fw-bold">{{ latest.weight_kg or 'N/A' }} kg</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Body Fat:</small>
                                <span class="fw-bold">{{ latest.body_fat_percent or 'N/A' }}%</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Muscle Mass:</small>
                                <span class="fw-bold">{{ latest.muscle_mass_kg or 'N/A' }} kg</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Body Temp:</small>
                                <span class="fw-bold">{{ latest.body_temperature or 'N/A' }}Â°C</span>
                            </div>
                        </div>
                        
                        <!-- Wellness Metrics -->
                        <div class="col-md-6 col-lg-4 mb-4">
                            <h6 class="text-info border-bottom pb-2"><i class="fas fa-smile me-1"></i>Wellness</h6>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Water Intake:</small>
                                <span class="fw-bold">{{ latest.water_intake_liters or 'N/A' }} L</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Mood Score:</small>
                                <span class="fw-bold">{{ latest.mood_score or 'N/A' }}/10</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Energy Level:</small>
                                <span class="fw-bold">{{ latest.energy_level or 'N/A' }}/10</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Stress Level:</small>
                                <span class="fw-bold">{{ latest.stress_level or 'N/A' }}/10</span>
                            </div>
                        </div>
                        
                        <!-- Workout Session -->
                        <div class="col-md-6 col-lg-4 mb-4">
                            <h6 class="text-secondary border-bottom pb-2"><i class="fas fa-dumbbell me-1"></i>Latest Workout</h6>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Type:</small>
                                <span class="fw-bold">{{ latest.workout_type.title() if latest.workout_type else 'N/A' }}</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Duration:</small>
                                <span class="fw-bold">{{ latest.workout_duration_minutes or 'N/A' }} min</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Intensity:</small>
                                <span class="fw-bold">{{ latest.workout_intensity.title() if latest.workout_intensity else 'N/A' }}</span>
                            </div>
                            <div class="metric-item mb-2">
                                <small class="text-muted">Calories:</small>
                                <span class="fw-bold">{{ latest.workout_calories or 'N/A' }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Historical Data Toggle -->
                    <div class="mt-3">
                        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#historicalData" aria-expanded="false" aria-controls="historicalData">
                            <i class="fas fa-history me-1"></i>View Historical Data (Last 7 Days)
                        </button>
                    </div>
                    
                    <div class="collapse mt-3" id="historicalData">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Sleep</th>
                                        <th>Steps</th>
                                        <th>Water</th>
                                        <th>Mood</th>
                                        <th>Active Min</th>
                                        <th>Weight</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for data in health_data %}
                                    <tr>
                                        <td><small>{{ data.date_logged.strftime('%m/%d') }}</small></td>
                                        <td><small>{{ data.sleep_duration_hours or '-' }}h</small></td>
                                        <td><small>{{ data.steps or '-' }}</small></td>
                                        <td><small>{{ data.water_intake_liters or '-' }}L</small></td>
                                        <td><small>{{ data.mood_score or '-' }}/10</small></td>
                                        <td><small>{{ data.active_minutes or '-' }}min</small></td>
                                        <td><small>{{ data.weight_kg or '-' }}kg</small></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% else %}
                    <div class="card-body">
                        <p class="text-muted text-center">No health data available yet. <a href="{{ url_for('main.log_data') }}">Log your first entry</a> to see comprehensive metrics.</p>
                    </div>
                {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Health Data Visualizations & Infographics -->
        {% if health_data and health_data|length > 0 %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2 text-primary"></i>Health Trends & Insights</h5>
                <small class="text-muted">Visual analysis of your health patterns over time</small>
            </div>
            <div class="card-body">
                <!-- Weekly Activity Overview Chart -->
                <div class="mb-4">
                    <h6 class="text-info mb-3"><i class="fas fa-running me-1"></i>Weekly Activity Overview</h6>
                    <canvas id="weeklyActivityChart" height="80"></canvas>
                </div>

                <!-- Sleep Quality Timeline -->
                <div class="mb-4">
                    <h6 class="text-primary mb-3"><i class="fas fa-moon me-1"></i>Sleep Quality Timeline</h6>
                    <canvas id="sleepQualityChart" height="80"></canvas>
                </div>

                <!-- Hydration Tracker -->
                <div class="mb-4">
                    <h6 class="text-info mb-3"><i class="fas fa-tint me-1"></i>Hydration Progress</h6>
                    <div class="row">
                        <div class="col-md-8">
                            <canvas id="hydrationChart" height="100"></canvas>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <div class="hydration-goal-circle mb-2">
                                    <svg width="120" height="120" viewBox="0 0 120 120">
                                        <circle cx="60" cy="60" r="50" fill="none" stroke="#e9ecef" stroke-width="10"></circle>
                                        <circle cx="60" cy="60" r="50" fill="none" stroke="#0dcaf0" stroke-width="10" 
                                                stroke-dasharray="314" 
                                                stroke-dashoffset="{{ 314 - (314 * ((latest.water_intake_liters or 0) / 3)) if latest and latest.water_intake_liters else 314 }}"
                                                transform="rotate(-90 60 60)"></circle>
                                        <text x="60" y="65" text-anchor="middle" font-size="24" fill="#0dcaf0" font-weight="bold">
                                            {{ ((latest.water_intake_liters or 0) / 3 * 100) | round if latest else 0 }}%
                                        </text>
                                    </svg>
                                </div>
                                <small class="text-muted">Daily Goal Progress</small>
                                <p class="mb-0 mt-2"><strong>{{ latest.water_intake_liters or 0 if latest else 0 }}L</strong> / 3L</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Heart Health Visualization -->
                <div class="mb-4">
                    <h6 class="text-danger mb-3"><i class="fas fa-heartbeat me-1"></i>Heart Health Metrics</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="heartRateChart" height="100"></canvas>
                        </div>
                        <div class="col-md-6">
                            <!-- Heart Rate Zones Infographic -->
                            <div class="heart-zones-infographic">
                                {% set resting_hr = latest.heart_rate_resting or 70 if latest else 70 %}
                                <div class="zone-item mb-2 p-2 rounded" style="background: linear-gradient(90deg, #d4edda 0%, #c3e6cb 100%);">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="small"><i class="fas fa-leaf me-1"></i>Resting Zone</span>
                                        <strong class="text-success">{{ resting_hr }} BPM</strong>
                                    </div>
                                    <div class="progress mt-1" style="height: 5px;">
                                        <div class="progress-bar bg-success" style="width: {% if resting_hr <= 80 %}100{% else %}50{% endif %}%"></div>
                                    </div>
                                </div>
                                {% set avg_hr = latest.heart_rate_avg or 85 if latest else 85 %}
                                <div class="zone-item mb-2 p-2 rounded" style="background: linear-gradient(90deg, #fff3cd 0%, #ffecb5 100%);">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="small"><i class="fas fa-walking me-1"></i>Average</span>
                                        <strong class="text-warning">{{ avg_hr }} BPM</strong>
                                    </div>
                                    <div class="progress mt-1" style="height: 5px;">
                                        <div class="progress-bar bg-warning" style="width: {{ (avg_hr / 120 * 100) | round }}%"></div>
                                    </div>
                                </div>
                                {% set max_hr = latest.heart_rate_max or 120 if latest else 120 %}
                                <div class="zone-item mb-2 p-2 rounded" style="background: linear-gradient(90deg, #f8d7da 0%, #f5c2c7 100%);">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="small"><i class="fas fa-running me-1"></i>Peak</span>
                                        <strong class="text-danger">{{ max_hr }} BPM</strong>
                                    </div>
                                    <div class="progress mt-1" style="height: 5px;">
                                        <div class="progress-bar bg-danger" style="width: {{ (max_hr / 180 * 100) | round }}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Wellness Correlation Matrix -->
                <div class="mb-4">
                    <h6 class="text-success mb-3"><i class="fas fa-project-diagram me-1"></i>Wellness Factor Correlation</h6>
                    <div class="correlation-matrix p-3 bg-light rounded">
                        <div class="row text-center">
                            <div class="col-md-3 mb-3">
                                <div class="correlation-card p-3 rounded bg-white shadow-sm">
                                    <i class="fas fa-bed fa-2x text-primary mb-2"></i>
                                    <h6 class="mb-1">Sleep</h6>
                                    <div class="correlation-indicator">
                                        <small class="text-muted">Impacts Mood</small>
                                        <div class="correlation-strength mt-1">
                                            <div class="strength-bar" style="width: 85%; background: linear-gradient(90deg, #0d6efd, #0dcaf0);"></div>
                                        </div>
                                        <strong class="text-primary">85%</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="correlation-card p-3 rounded bg-white shadow-sm">
                                    <i class="fas fa-running fa-2x text-success mb-2"></i>
                                    <h6 class="mb-1">Activity</h6>
                                    <div class="correlation-indicator">
                                        <small class="text-muted">Impacts Energy</small>
                                        <div class="correlation-strength mt-1">
                                            <div class="strength-bar" style="width: 78%; background: linear-gradient(90deg, #198754, #20c997);"></div>
                                        </div>
                                        <strong class="text-success">78%</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="correlation-card p-3 rounded bg-white shadow-sm">
                                    <i class="fas fa-tint fa-2x text-info mb-2"></i>
                                    <h6 class="mb-1">Hydration</h6>
                                    <div class="correlation-indicator">
                                        <small class="text-muted">Impacts Focus</small>
                                        <div class="correlation-strength mt-1">
                                            <div class="strength-bar" style="width: 72%; background: linear-gradient(90deg, #0dcaf0, #6ea8fe);"></div>
                                        </div>
                                        <strong class="text-info">72%</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="correlation-card p-3 rounded bg-white shadow-sm">
                                    <i class="fas fa-heart fa-2x text-danger mb-2"></i>
                                    <h6 class="mb-1">Heart Health</h6>
                                    <div class="correlation-indicator">
                                        <small class="text-muted">Impacts Stamina</small>
                                        <div class="correlation-strength mt-1">
                                            <div class="strength-bar" style="width: 80%; background: linear-gradient(90deg, #dc3545, #fd7e14);"></div>
                                        </div>
                                        <strong class="text-danger">80%</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Health Score Breakdown Radar Chart -->
                <div class="mb-4">
                    <h6 class="text-warning mb-3"><i class="fas fa-chart-area me-1"></i>Health Score Breakdown</h6>
                    <canvas id="healthRadarChart" height="100"></canvas>
                </div>

                <!-- Weekly Summary Infographic -->
                <div class="mb-4">
                    <h6 class="text-secondary mb-3"><i class="fas fa-calendar-week me-1"></i>Weekly Summary</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="summary-card p-3 text-center rounded" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <i class="fas fa-shoe-prints fa-2x text-white mb-2"></i>
                                <h4 class="text-white mb-0">
                                    {% set total_steps = namespace(value=0) %}
                                    {% for data in health_data[:7] %}
                                        {% set total_steps.value = total_steps.value + (data.steps or 0) %}
                                    {% endfor %}
                                    {{ (total_steps.value / 1000) | round(1) }}K
                                </h4>
                                <small class="text-white-50">Total Steps This Week</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="summary-card p-3 text-center rounded" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <i class="fas fa-fire fa-2x text-white mb-2"></i>
                                <h4 class="text-white mb-0">
                                    {% set total_calories = namespace(value=0) %}
                                    {% for data in health_data[:7] %}
                                        {% set total_calories.value = total_calories.value + (data.calories_total or 0) %}
                                    {% endfor %}
                                    {{ total_calories.value }}
                                </h4>
                                <small class="text-white-50">Calories Burned</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="summary-card p-3 text-center rounded" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                <i class="fas fa-clock fa-2x text-white mb-2"></i>
                                <h4 class="text-white mb-0">
                                    {% set avg_sleep = namespace(value=0, count=0) %}
                                    {% for data in health_data[:7] %}
                                        {% if data.sleep_duration_hours %}
                                            {% set avg_sleep.value = avg_sleep.value + data.sleep_duration_hours %}
                                            {% set avg_sleep.count = avg_sleep.count + 1 %}
                                        {% endif %}
                                    {% endfor %}
                                    {{ (avg_sleep.value / avg_sleep.count if avg_sleep.count > 0 else 0) | round(1) }}h
                                </h4>
                                <small class="text-white-50">Avg Sleep/Night</small>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        {% endif %}
        
    </div>
    
    <div class="col-md-4">
        <!-- AI Recommendations -->
        {% if ai_recommendations %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-robot me-2 text-info"></i>AI Recommendations</h5>
            </div>
            <div class="card-body">
                {% for recommendation in ai_recommendations[:3] %}
                <div class="alert alert-{{ 'success' if recommendation.recommendation_type == 'positive' else 'warning' if recommendation.recommendation_type == 'improvement' else 'info' }} advice-alert py-2">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-lightbulb me-2 mt-1"></i>
                        <div>
                            <strong>{{ recommendation.recommendation_type.title() }}</strong>
                            <p class="mb-0 small">{{ recommendation.description }}</p>
                            {% if recommendation.ai_confidence %}
                            <small class="text-muted">Confidence: {{ (recommendation.ai_confidence * 100) | round }}%</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- AI-Powered Personalized Advice -->
        <div class="card mb-4" id="personalizedAdviceCard">
            <div class="card-header">
                <h5 class="mb-0">
                    <button class="btn btn-link text-decoration-none p-0 w-100 text-start d-flex justify-content-between align-items-center" 
                            type="button" data-bs-toggle="collapse" data-bs-target="#personalizedAdvice" 
                            aria-expanded="false" aria-controls="personalizedAdvice">
                        <span><i class="fas fa-brain me-2 text-success"></i>Personalized Health Advice</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </h5>
                <small class="text-muted">AI-generated insights based on your health patterns</small>
            </div>
            <div class="collapse" id="personalizedAdvice">
                <div class="card-body">
                    <!-- Loading state -->
                    <div id="adviceLoadingState" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Generating advice...</span>
                        </div>
                        <p class="mt-2 text-muted">Analyzing your health patterns...</p>
                    </div>
                    
                    <!-- Advice content -->
                    <div id="adviceContent">
                        {% if ai_advice %}
                        <!-- Existing advice content -->
                        <div id="actualAdviceContent">
                            <!-- Refresh button -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0 text-success"><i class="fas fa-sparkles me-1"></i>Your Latest Health Insights</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="generateHealthAdvice()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh Advice
                                </button>
                            </div>
                            
                            <!-- Key Insights -->
                            {% if ai_advice.insights %}
                            <div id="adviceInsights" class="mb-3">
                                <h6 class="text-primary"><i class="fas fa-eye me-1"></i>Key Insights</h6>
                                <div id="insightsContent">
                                    {% for insight in ai_advice.insights %}
                                    <div class="alert alert-info advice-alert py-2 mb-2">
                                        <small><i class="fas fa-lightbulb me-1"></i>{{ insight }}</small>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Priority Recommendations -->
                            {% if ai_advice.recommendations %}
                            <div id="adviceRecommendations" class="mb-3">
                                <h6 class="text-success"><i class="fas fa-star me-1"></i>Priority Recommendations</h6>
                                <div id="recommendationsContent">
                                    {% for recommendation in ai_advice.recommendations %}
                                    <div class="alert alert-success advice-alert py-2 mb-2">
                                        <small><i class="fas fa-arrow-right me-1"></i>{{ recommendation }}</small>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Quick Wins -->
                            {% if ai_advice.quick_wins %}
                            <div id="adviceQuickWins" class="mb-3">
                                <h6 class="text-warning"><i class="fas fa-bolt me-1"></i>Quick Wins</h6>
                                <div id="quickWinsContent">
                                    {% for quick_win in ai_advice.quick_wins %}
                                    <div class="alert alert-warning advice-alert py-2 mb-2">
                                        <small><i class="fas fa-check me-1"></i>{{ quick_win }}</small>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Areas of Concern -->
                            {% if ai_advice.concerns %}
                            <div id="adviceConcerns" class="mb-3">
                                <h6 class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Areas to Watch</h6>
                                <div id="concernsContent">
                                    {% for concern in ai_advice.concerns %}
                                    <div class="alert alert-danger advice-alert py-2 mb-2">
                                        <small><i class="fas fa-info-circle me-1"></i>{{ concern }}</small>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Motivation Message -->
                            {% if ai_advice.motivation %}
                            <div id="adviceMotivation" class="mb-3">
                                <div class="bg-light p-3 rounded">
                                    <h6 class="text-primary mb-2"><i class="fas fa-heart me-1"></i>Stay Motivated</h6>
                                    <p class="mb-0 small text-muted" id="motivationContent">{{ ai_advice.motivation }}</p>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Source Information -->
                            <div id="adviceSource" class="mt-3 pt-2 border-top">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <span id="sourceInfo">Generated by {{ 'AI Assistant' if ai_advice.source == 'gemini_ai' else 'Health Analytics' }}{% if ai_advice.generated_at %} at {{ ai_advice.generated_at[:19] | replace('T', ' ') }}{% endif %}</span>
                                    <br><em>This advice is for informational purposes and not a substitute for professional medical consultation.</em>
                                </small>
                            </div>
                        </div>
                        {% else %}
                        <!-- No advice message -->
                        <div class="text-center py-4" id="noAdviceMessage">
                            <i class="fas fa-lightbulb fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">No personalized advice generated yet</h6>
                            <p class="text-muted small mb-3">Click the button below to generate AI-powered health insights based on your recent health data.</p>
                            <button type="button" class="btn btn-primary" onclick="generateHealthAdvice()">
                                <i class="fas fa-brain me-1"></i>Generate Health Advice
                            </button>
                        </div>
                        
                        <!-- Actual advice content (initially hidden) -->
                        <div id="actualAdviceContent" style="display: none;">
                            <!-- Refresh button -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0 text-success"><i class="fas fa-sparkles me-1"></i>Your Latest Health Insights</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="generateHealthAdvice()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh Advice
                                </button>
                            </div>
                            
                            <!-- Key Insights -->
                            <div id="adviceInsights" class="mb-3" style="display: none;">
                                <h6 class="text-primary"><i class="fas fa-eye me-1"></i>Key Insights</h6>
                                <div id="insightsContent"></div>
                            </div>
                            
                            <!-- Priority Recommendations -->
                            <div id="adviceRecommendations" class="mb-3" style="display: none;">
                                <h6 class="text-success"><i class="fas fa-star me-1"></i>Priority Recommendations</h6>
                                <div id="recommendationsContent"></div>
                            </div>
                            
                            <!-- Quick Wins -->
                            <div id="adviceQuickWins" class="mb-3" style="display: none;">
                                <h6 class="text-warning"><i class="fas fa-bolt me-1"></i>Quick Wins</h6>
                                <div id="quickWinsContent"></div>
                            </div>
                            
                            <!-- Areas of Concern -->
                            <div id="adviceConcerns" class="mb-3" style="display: none;">
                                <h6 class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Areas to Watch</h6>
                                <div id="concernsContent"></div>
                            </div>
                            
                            <!-- Motivation Message -->
                            <div id="adviceMotivation" class="mb-3" style="display: none;">
                                <div class="bg-light p-3 rounded">
                                    <h6 class="text-primary mb-2"><i class="fas fa-heart me-1"></i>Stay Motivated</h6>
                                    <p class="mb-0 small text-muted" id="motivationContent"></p>
                                </div>
                            </div>
                            
                            <!-- Source Information -->
                            <div id="adviceSource" class="mt-3 pt-2 border-top" style="display: none;">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <span id="sourceInfo"></span>
                                    <br><em>This advice is for informational purposes and not a substitute for professional medical consultation.</em>
                                </small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bolt me-2 text-warning"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('main.log_data') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Log Health Data
                    </a>
                    <a href="{{ url_for('main.add_calendar_event') }}" class="btn btn-success">
                        <i class="fas fa-calendar-plus me-1"></i>Add Event
                    </a>
                    {% if preferences and (preferences.ai_optimization_enabled or preferences.smart_reminders_enabled) %}
                    <button class="btn btn-info" onclick="triggerAIOptimization()">
                        <i class="fas fa-robot me-1"></i>AI Optimize Schedule
                    </button>
                    {% endif %}
                    <a href="{{ url_for('main.user_preferences') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-cog me-1"></i>Settings
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Upcoming Calendar Events -->
        {% if upcoming_events %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-calendar-alt me-2 text-warning"></i>Upcoming Events</h5>
                <a href="{{ url_for('main.calendar') }}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                {% for event in upcoming_events[:3] %}
                <div class="d-flex align-items-center mb-2 {% if not loop.last %}border-bottom pb-2{% endif %}">
                    <div class="me-3">
                        {% if event.event_type == 'work' %}
                            <i class="fas fa-briefcase text-primary"></i>
                        {% elif event.event_type == 'exercise' %}
                            <i class="fas fa-dumbbell text-success"></i>
                        {% elif event.event_type == 'meal' %}
                            <i class="fas fa-utensils text-warning"></i>
                        {% elif event.event_type == 'health' %}
                            <i class="fas fa-stethoscope text-info"></i>
                        {% else %}
                            <i class="fas fa-calendar text-secondary"></i>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">{{ event.title }}</div>
                        <small class="text-muted">{{ event.start_time.strftime('%Y-%m-%d %H:%M') }}</small>
                    </div>
                    <div>
                        {% if event.is_ai_modifiable %}
                            <span class="badge bg-success"><i class="fas fa-robot"></i></span>
                        {% else %}
                            <span class="badge bg-secondary"><i class="fas fa-lock"></i></span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Health Streak -->
        {% if health_streak %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-fire me-2 text-danger"></i>Health Streak</h5>
            </div>
            <div class="card-body text-center">
                <h2 class="display-4 text-success">{{ health_streak.current_streak }}</h2>
                <p class="mb-1">Days of consistent health tracking</p>
                <small class="text-muted">Best streak: {{ health_streak.best_streak }} days</small>
            </div>
        </div>
        {% endif %}
        
        <!-- System Status -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2 text-info"></i>System Status</h5>
            </div>
            <div class="card-body">
                <div class="status-item d-flex justify-content-between align-items-center mb-2">
                    <span>AI Services</span>
                    <span class="badge bg-success">Active</span>
                </div>
                <div class="status-item d-flex justify-content-between align-items-center mb-2">
                    <span>Wearable Device</span>
                    <span class="badge bg-{{ 'success' if samsung_health_connected else 'secondary' }}">
                        {{ 'Connected' if samsung_health_connected else 'Disconnected' }}
                    </span>
                </div>
                <div class="status-item d-flex justify-content-between align-items-center">
                    <span>Data Sync</span>
                    <span class="badge bg-{{ 'success' if last_sync_time else 'warning' }}">
                        {{ last_sync_time.strftime('%H:%M') if last_sync_time else 'Pending' }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function triggerAIOptimization() {
    // Redirect to calendar with optimization trigger
    window.location.href = "{{ url_for('main.calendar') }}?optimize=true";
}

// Remember collapsible section states
document.addEventListener('DOMContentLoaded', function() {
    // List of collapsible sections to remember (including new advice section)
    const collapsibleSections = ['comprehensiveMetrics', 'historicalData', 'personalizedAdvice'];
    
    // Restore saved states
    collapsibleSections.forEach(function(sectionId) {
        const savedState = localStorage.getItem('dashboard_' + sectionId);
        const element = document.getElementById(sectionId);
        
        if (element && savedState === 'show') {
            // Show the section if it was previously open
            element.classList.add('show');
            // Update the chevron icon
            const button = document.querySelector('[data-bs-target="#' + sectionId + '"]');
            if (button) {
                const icon = button.querySelector('.fa-chevron-down');
                if (icon) {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                }
            }
        }
    });
    
    // Save state when sections are toggled
    collapsibleSections.forEach(function(sectionId) {
        const element = document.getElementById(sectionId);
        if (element) {
            element.addEventListener('shown.bs.collapse', function() {
                localStorage.setItem('dashboard_' + sectionId, 'show');
                // Update chevron icon
                const button = document.querySelector('[data-bs-target="#' + sectionId + '"]');
                if (button) {
                    const icon = button.querySelector('.fa-chevron-down');
                    if (icon) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    }
                }
            });
            
            element.addEventListener('hidden.bs.collapse', function() {
                localStorage.setItem('dashboard_' + sectionId, 'hide');
                // Update chevron icon
                const button = document.querySelector('[data-bs-target="#' + sectionId + '"]');
                if (button) {
                    const icon = button.querySelector('.fa-chevron-up');
                    if (icon) {
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    }
                }
            });
        }
    });
});

// Function to generate health advice via AJAX
function generateHealthAdvice() {
    // Show loading state
    document.getElementById('adviceLoadingState').style.display = 'block';
    
    // Hide existing content
    const noAdviceMessage = document.getElementById('noAdviceMessage');
    const actualAdviceContent = document.getElementById('actualAdviceContent');
    
    if (noAdviceMessage) {
        noAdviceMessage.style.display = 'none';
    }
    if (actualAdviceContent) {
        actualAdviceContent.style.display = 'none';
    }
    
    // Make AJAX request to generate advice
    fetch('{{ url_for("main.generate_personalized_advice") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Hide loading state
        document.getElementById('adviceLoadingState').style.display = 'none';
        
        if (data.success && data.ai_advice) {
            // Show advice content
            displayAdviceContent(data.ai_advice);
        } else {
            // Show error message
            showAdviceError(data.error || 'Failed to generate health advice');
        }
    })
    .catch(error => {
        console.error('Error generating advice:', error);
        document.getElementById('adviceLoadingState').style.display = 'none';
        showAdviceError('Network error occurred while generating advice');
    });
}

// Function to display advice content
function displayAdviceContent(advice) {
    // Show the actual advice content
    const actualAdviceContent = document.getElementById('actualAdviceContent');
    if (actualAdviceContent) {
        actualAdviceContent.style.display = 'block';
    }
    
    // Hide no advice message
    const noAdviceMessage = document.getElementById('noAdviceMessage');
    if (noAdviceMessage) {
        noAdviceMessage.style.display = 'none';
    }
    
    // Helper function to create alert elements for content
    function createAlertContent(content, alertClass, iconClass) {
        if (!content) return '';
        
        if (typeof content === 'string') {
            return `<div class="alert ${alertClass} advice-alert py-2 mb-2">
                        <small><i class="${iconClass} me-1"></i>${content}</small>
                    </div>`;
        } else if (Array.isArray(content)) {
            return content.filter(item => item && item.length > 0)
                         .map(item => `<div class="alert ${alertClass} advice-alert py-2 mb-2">
                                          <small><i class="${iconClass} me-1"></i>${item}</small>
                                       </div>`)
                         .join('');
        }
        return '';
    }
    
    // Display insights
    if (advice.insights) {
        const insightsContent = createAlertContent(advice.insights, 'alert-info', 'fas fa-lightbulb');
        if (insightsContent) {
            document.getElementById('insightsContent').innerHTML = insightsContent;
            document.getElementById('adviceInsights').style.display = 'block';
        }
    }
    
    // Display recommendations
    if (advice.recommendations) {
        const recommendationsContent = createAlertContent(advice.recommendations, 'alert-success', 'fas fa-arrow-right');
        if (recommendationsContent) {
            document.getElementById('recommendationsContent').innerHTML = recommendationsContent;
            document.getElementById('adviceRecommendations').style.display = 'block';
        }
    }
    
    // Display quick wins
    if (advice.quick_wins) {
        const quickWinsContent = createAlertContent(advice.quick_wins, 'alert-warning', 'fas fa-check');
        if (quickWinsContent) {
            document.getElementById('quickWinsContent').innerHTML = quickWinsContent;
            document.getElementById('adviceQuickWins').style.display = 'block';
        }
    }
    
    // Display concerns
    if (advice.concerns) {
        const concernsContent = createAlertContent(advice.concerns, 'alert-danger', 'fas fa-info-circle');
        if (concernsContent) {
            document.getElementById('concernsContent').innerHTML = concernsContent;
            document.getElementById('adviceConcerns').style.display = 'block';
        }
    }
    
    // Display motivation
    if (advice.motivation) {
        document.getElementById('motivationContent').textContent = advice.motivation;
        document.getElementById('adviceMotivation').style.display = 'block';
    }
    
    // Display source information
    if (advice.source || advice.generated_at) {
        const sourceText = `Generated by ${advice.source === 'gemini_ai' ? 'AI Assistant' : 'Health Analytics'}${advice.generated_at ? ' at ' + new Date(advice.generated_at).toLocaleString() : ''}`;
        document.getElementById('sourceInfo').textContent = sourceText;
        document.getElementById('adviceSource').style.display = 'block';
    }
}

// Function to show error message
function showAdviceError(errorMessage) {
    const noAdviceMessage = document.getElementById('noAdviceMessage');
    if (noAdviceMessage) {
        noAdviceMessage.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                <h6 class="text-warning">Unable to Generate Advice</h6>
                <p class="text-muted small mb-3">${errorMessage}</p>
                <button type="button" class="btn btn-primary" onclick="generateHealthAdvice()">
                    <i class="fas fa-redo me-1"></i>Try Again
                </button>
            </div>
        `;
        noAdviceMessage.style.display = 'block';
    }
    
    const actualAdviceContent = document.getElementById('actualAdviceContent');
    if (actualAdviceContent) {
        actualAdviceContent.style.display = 'none';
    }
}

// Auto-refresh dashboard every 5 minutes (but preserve collapse states)
setInterval(function() {
    // Only refresh if user is still active
    if (document.hasFocus()) {
        // Save current collapse states before refresh
        const collapsibleSections = ['comprehensiveMetrics', 'historicalData', 'personalizedAdvice'];
        collapsibleSections.forEach(function(sectionId) {
            const element = document.getElementById(sectionId);
            if (element && element.classList.contains('show')) {
                localStorage.setItem('dashboard_' + sectionId, 'show');
            }
        });
        location.reload();
    }
}, 300000);

// Initialize Health Visualization Charts
{% if health_data_json and health_data_json|length > 0 %}
document.addEventListener('DOMContentLoaded', function() {
    
    // Prepare data for charts
    const healthData = {{ health_data_json | tojson }};
    const labels = healthData.map((data, index) => {
        const date = new Date(data.date);
        return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }).reverse();
    
    // Weekly Activity Chart (Steps + Calories)
    const weeklyActivityCtx = document.getElementById('weeklyActivityChart').getContext('2d');
    new Chart(weeklyActivityCtx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Steps (scaled /100)',
                    data: healthData.map(d => (d.steps || 0) / 100).reverse(),
                    backgroundColor: 'rgba(13, 110, 253, 0.5)',
                    borderColor: 'rgba(13, 110, 253, 1)',
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    label: 'Calories Burned',
                    data: healthData.map(d => d.calories_total || 0).reverse(),
                    backgroundColor: 'rgba(255, 99, 132, 0.5)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label === 'Steps (scaled /100)') {
                                return 'Steps: ' + (context.parsed.y * 100).toLocaleString();
                            }
                            return label + ': ' + context.parsed.y;
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Steps (Ã·100)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Calories'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
    
    // Sleep Quality Timeline
    const sleepQualityCtx = document.getElementById('sleepQualityChart').getContext('2d');
    new Chart(sleepQualityCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Sleep Hours',
                data: healthData.map(d => d.sleep_duration_hours || 0).reverse(),
                backgroundColor: 'rgba(111, 66, 193, 0.2)',
                borderColor: 'rgba(111, 66, 193, 1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true
                },
                annotation: {
                    annotations: {
                        line1: {
                            type: 'line',
                            yMin: 7,
                            yMax: 7,
                            borderColor: 'rgba(40, 167, 69, 0.5)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                content: 'Recommended: 7-9 hours',
                                enabled: true,
                                position: 'end'
                            }
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 12,
                    title: {
                        display: true,
                        text: 'Hours'
                    }
                }
            }
        }
    });
    
    // Hydration Progress Chart
    const hydrationCtx = document.getElementById('hydrationChart').getContext('2d');
    new Chart(hydrationCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Water Intake (Liters)',
                data: healthData.map(d => d.water_intake_liters || 0).reverse(),
                backgroundColor: 'rgba(13, 202, 240, 0.2)',
                borderColor: 'rgba(13, 202, 240, 1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 4,
                    title: {
                        display: true,
                        text: 'Liters'
                    }
                }
            }
        }
    });
    
    // Heart Rate Multi-Line Chart
    const heartRateCtx = document.getElementById('heartRateChart').getContext('2d');
    new Chart(heartRateCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Resting HR',
                    data: healthData.map(d => d.heart_rate_resting || null).reverse(),
                    borderColor: 'rgba(40, 167, 69, 1)',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderWidth: 2,
                    tension: 0.3
                },
                {
                    label: 'Average HR',
                    data: healthData.map(d => d.heart_rate_avg || null).reverse(),
                    borderColor: 'rgba(255, 193, 7, 1)',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    borderWidth: 2,
                    tension: 0.3
                },
                {
                    label: 'Max HR',
                    data: healthData.map(d => d.heart_rate_max || null).reverse(),
                    borderColor: 'rgba(220, 53, 69, 1)',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    borderWidth: 2,
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    min: 50,
                    max: 180,
                    title: {
                        display: true,
                        text: 'BPM'
                    }
                }
            }
        }
    });
    
    // Health Score Breakdown Radar Chart
    const healthRadarCtx = document.getElementById('healthRadarChart').getContext('2d');
    const latestData = healthData[0]; // Most recent data
    
    // Calculate individual scores (simplified version)
    const activityScore = Math.min(100, ((latestData.steps || 0) / 10000) * 100);
    const sleepScore = Math.min(100, ((latestData.sleep_duration_hours || 0) / 8) * 100);
    const hydrationScore = Math.min(100, ((latestData.water_intake_liters || 0) / 3) * 100);
    const heartHealthScore = latestData.heart_rate_resting ? Math.max(0, 100 - Math.abs(70 - latestData.heart_rate_resting)) : 50;
    const nutritionScore = latestData.calories_consumed ? Math.min(100, (latestData.calories_consumed / 2000) * 100) : 50;
    const wellnessScore = (latestData.mood_score || 5) * 20; // Assuming 1-5 scale
    
    new Chart(healthRadarCtx, {
        type: 'radar',
        data: {
            labels: ['Activity (25%)', 'Sleep (25%)', 'Hydration (15%)', 'Heart Health (15%)', 'Nutrition (15%)', 'Wellness (5%)'],
            datasets: [{
                label: 'Your Health Profile',
                data: [activityScore, sleepScore, hydrationScore, heartHealthScore, nutritionScore, wellnessScore],
                backgroundColor: 'rgba(111, 66, 193, 0.2)',
                borderColor: 'rgba(111, 66, 193, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(111, 66, 193, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(111, 66, 193, 1)'
            }]
        },
        options: {
            responsive: true,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        stepSize: 20
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
});
{% endif %}

</script>
{% endblock %}
