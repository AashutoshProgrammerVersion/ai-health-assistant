{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <!-- Calendar Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-calendar-alt me-2"></i>My Calendar</h2>
                <p class="text-muted mb-0">Manage your events and let AI optimize your schedule</p>
            </div>
            <div>
                <a href="{{ url_for('main.add_calendar_event') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>Add Event
                </a>
                {% if preferences and preferences.google_calendar_connected %}
                <button type="button" class="btn btn-outline-success ms-2" onclick="syncGoogleCalendar()">
                    <i class="fas fa-sync me-1"></i>Sync Google
                </button>
                {% else %}
                <a href="{{ url_for('main.connect_google_calendar') }}" class="btn btn-outline-primary ms-2">
                    <i class="fab fa-google me-1"></i>Connect Google Calendar
                </a>
                {% endif %}
                {% if preferences and (preferences.ai_optimization_enabled or preferences.smart_reminders_enabled) %}
                <button type="button" class="btn btn-info ms-2" onclick="optimizeSchedule()">
                    <i class="fas fa-robot me-1"></i>AI Optimize
                </button>
                <button type="button" class="btn btn-outline-warning ms-1" onclick="resetTodayOptimization()" title="Reset today's AI optimization (for testing)">
                    <i class="fas fa-undo me-1"></i>Reset Today
                </button>
                {% endif %}
            </div>
        </div>

        <!-- AI Optimization Status -->
        {% if preferences %}
        <div class="alert alert-info" role="alert">
            <i class="fas fa-info-circle me-2"></i>
            <strong>AI Features:</strong> 
            {% if preferences.ai_optimization_enabled and preferences.smart_reminders_enabled %}
                <span class="text-success">Schedule Optimization & Smart Reminders Enabled</span> - AI can move events and add intelligent reminders
            {% elif preferences.ai_optimization_enabled %}
                <span class="text-success">Schedule Optimization Enabled</span> - AI can suggest schedule improvements (reminders disabled)
            {% elif preferences.smart_reminders_enabled %}
                <span class="text-success">Smart Reminders Enabled</span> - AI can generate intelligent reminders (schedule optimization disabled)
            {% else %}
                <span class="text-muted">AI Features Disabled</span> - Enable in <a href="{{ url_for('main.user_preferences') }}">Settings</a>
            {% endif %}
        </div>
        {% endif %}

        <!-- Calendar Navigation -->
        <div class="calendar-navigation d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-outline-secondary" onclick="changeMonth(-1)">
                <i class="fas fa-chevron-left"></i>
            </button>
            <h4 class="month-year mb-0" id="currentMonth"></h4>
            <button class="btn btn-outline-secondary" onclick="changeMonth(1)">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>

        <!-- View Toggle -->
        <div class="mb-3">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary active" onclick="switchView('month')" id="monthViewBtn">
                    <i class="fas fa-calendar me-1"></i>Month
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="switchView('week')" id="weekViewBtn">
                    <i class="fas fa-calendar-week me-1"></i>Week
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="switchView('list')" id="listViewBtn">
                    <i class="fas fa-list me-1"></i>List
                </button>
            </div>
        </div>

        <!-- Calendar Grid -->
        <div id="monthView" class="calendar-view">
            <div class="calendar-container">
                <!-- Days of Week Header -->
                <div class="calendar-header">
                    <div class="day-header">Sun</div>
                    <div class="day-header">Mon</div>
                    <div class="day-header">Tue</div>
                    <div class="day-header">Wed</div>
                    <div class="day-header">Thu</div>
                    <div class="day-header">Fri</div>
                    <div class="day-header">Sat</div>
                </div>
                <!-- Calendar Days Grid -->
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Days will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Week View -->
        <div id="weekView" class="calendar-view" style="display: none;">
            <div class="week-container">
                <div class="week-header">
                    <div class="time-column">Time</div>
                    <div class="week-days" id="weekDays">
                        <!-- Week days will be populated by JavaScript -->
                    </div>
                </div>
                <div class="week-grid" id="weekGrid">
                    <!-- Time slots will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- List View -->
        <div id="listView" class="calendar-view" style="display: none;">
            <div class="row">
                {% if events %}
                    {% for event in events %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100 event-card" data-event-type="{{ event.event_type }}">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span class="event-type-badge badge bg-{{ 'primary' if event.event_type == 'work' else 'success' if event.event_type == 'exercise' else 'warning' if event.event_type == 'meal' else 'info' if event.event_type == 'health' else 'secondary' }}">
                                    {% if event.event_type == 'work' %}
                                        <i class="fas fa-briefcase"></i>
                                    {% elif event.event_type == 'exercise' %}
                                        <i class="fas fa-dumbbell"></i>
                                    {% elif event.event_type == 'meal' %}
                                        <i class="fas fa-utensils"></i>
                                    {% elif event.event_type == 'health' %}
                                        <i class="fas fa-stethoscope"></i>
                                    {% elif event.event_type == 'sleep' %}
                                        <i class="fas fa-bed"></i>
                                    {% else %}
                                        <i class="fas fa-calendar"></i>
                                    {% endif %}
                                    {{ event.event_type.title() }}
                                </span>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{{ url_for('main.edit_calendar_event', event_id=event.id) }}">
                                            <i class="fas fa-edit me-2"></i>Edit
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <form method="POST" action="{{ url_for('main.delete_calendar_event', event_id=event.id) }}" style="display: inline;">
                                                <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Are you sure you want to delete this event?')">
                                                    <i class="fas fa-trash me-2"></i>Delete
                                                </button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">{{ event.title }}</h5>
                                {% if event.description %}
                                <p class="card-text text-muted">{{ event.description[:100] }}{% if event.description|length > 100 %}...{% endif %}</p>
                                {% endif %}
                                
                                <div class="event-details">
                                    <div class="mb-2">
                                        <i class="fas fa-clock me-2 text-primary"></i>
                                        <strong>{{ event.start_time.strftime('%Y-%m-%d %H:%M') }}</strong>
                                        to {{ event.end_time.strftime('%H:%M') }}
                                    </div>
                                    
                                    <div class="mb-2">
                                        <i class="fas fa-flag me-2 text-warning"></i>
                                        Priority: 
                                        {% set priority_names = {1: 'Very Low', 2: 'Low', 3: 'Normal', 4: 'High', 5: 'Very High'} %}
                                        <span class="badge bg-{{ 'danger' if event.priority_level >= 4 else 'warning' if event.priority_level == 3 else 'secondary' }}">
                                            {{ priority_names[event.priority_level] }}
                                        </span>
                                    </div>
                                    
                                    <div class="ai-settings mt-2">
                                        {% if event.is_fixed_time %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-lock me-1"></i>Fixed Time
                                            </span>
                                        {% elif not event.is_ai_modifiable %}
                                            <span class="badge bg-warning">
                                                <i class="fas fa-hand-paper me-1"></i>AI Disabled
                                            </span>
                                        {% else %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-robot me-1"></i>AI Enabled
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="fas fa-calendar-plus fa-3x text-muted mb-3"></i>
                            <h4>No events scheduled</h4>
                            <p class="text-muted">Start by adding your first event to let AI help optimize your schedule!</p>
                            <a href="{{ url_for('main.add_calendar_event') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-1"></i>Add Your First Event
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="eventModalBody">
                <!-- Event details will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editEventBtn">Edit Event</button>
                <button type="button" class="btn btn-danger" id="deleteEventBtn">Delete Event</button>
            </div>
        </div>
    </div>
</div>

<!-- AI Optimization Modal -->
<div class="modal fade" id="optimizationModal" tabindex="-1" aria-labelledby="optimizationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="optimizationModalLabel">
                    <i class="fas fa-robot me-2"></i>
                    {% if preferences and preferences.ai_optimization_enabled and preferences.smart_reminders_enabled %}
                    AI Schedule Optimization & Smart Reminders
                    {% elif preferences and preferences.ai_optimization_enabled %}
                    AI Schedule Optimization
                    {% elif preferences and preferences.smart_reminders_enabled %}
                    AI Smart Reminders
                    {% else %}
                    AI Features
                    {% endif %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="optimizationContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Analyzing schedule...</span>
                        </div>
                        <p class="mt-2">AI is analyzing your schedule and health patterns...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Calendar Styles */
.calendar-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
}

.calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.day-header {
    padding: 12px 8px;
    text-align: center;
    font-weight: 600;
    color: #6c757d;
    border-right: 1px solid #dee2e6;
}

.day-header:last-child {
    border-right: none;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    grid-template-rows: repeat(6, 120px);
}

.calendar-day {
    border-right: 1px solid #dee2e6;
    border-bottom: 1px solid #dee2e6;
    padding: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
    position: relative;
    overflow: hidden;
}

.calendar-day:hover {
    background-color: #f8f9fa;
}

.calendar-day:last-child {
    border-right: none;
}

.calendar-day.today {
    background-color: #e3f2fd;
}

.calendar-day.other-month {
    color: #adb5bd;
    background-color: #f8f9fa;
}

.day-number {
    font-weight: 600;
    margin-bottom: 4px;
}

.day-events {
    display: flex;
    flex-direction: column;
    gap: 2px;
    max-height: 90px;
    overflow: hidden;
}

.event-dot {
    background: #007bff;
    color: white;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
    cursor: pointer;
    transition: transform 0.2s;
}

.event-dot:hover {
    transform: scale(1.05);
}

.event-dot.work { background: #007bff; }
.event-dot.exercise { background: #28a745; }
.event-dot.meal { background: #ffc107; color: #000; }
.event-dot.health { background: #17a2b8; }
.event-dot.sleep { background: #6f42c1; }
.event-dot.other { background: #6c757d; }

.more-events {
    font-size: 10px;
    color: #6c757d;
    text-align: center;
    cursor: pointer;
}

/* Week View Styles */
.week-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
}

.week-header {
    display: grid;
    grid-template-columns: 80px 1fr;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.time-column {
    padding: 12px 8px;
    text-align: center;
    font-weight: 600;
    color: #6c757d;
    border-right: 1px solid #dee2e6;
}

.week-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
}

.week-day {
    padding: 12px 8px;
    text-align: center;
    font-weight: 600;
    color: #6c757d;
    border-right: 1px solid #dee2e6;
}

.week-day:last-child {
    border-right: none;
}

.week-grid {
    display: grid;
    grid-template-columns: 80px 1fr;
    max-height: 600px;
    overflow-y: auto;
}

.time-slots {
    display: flex;
    flex-direction: column;
}

.time-slot {
    height: 60px;
    padding: 8px;
    border-bottom: 1px solid #dee2e6;
    border-right: 1px solid #dee2e6;
    font-size: 12px;
    color: #6c757d;
    display: flex;
    align-items: flex-start;
}

.week-events {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    position: relative;
}

.week-day-column {
    border-right: 1px solid #dee2e6;
    position: relative;
}

.week-day-column:last-child {
    border-right: none;
}

.week-event {
    position: absolute;
    left: 2px;
    right: 2px;
    background: #007bff;
    color: white;
    padding: 2px 4px;
    border-radius: 4px;
    font-size: 11px;
    cursor: pointer;
    z-index: 1;
}

.calendar-navigation {
    padding: 0 1rem;
}

.btn-group .btn.active {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
}

@media (max-width: 768px) {
    .calendar-grid {
        grid-template-rows: repeat(6, 80px);
    }
    
    .calendar-day {
        padding: 4px;
    }
    
    .day-events {
        max-height: 50px;
    }
    
    .event-dot {
        font-size: 8px;
        padding: 1px 4px;
    }
}
</style>

{% endblock %}

{% block scripts %}
<script>
// Calendar state
let currentDate = new Date();
let currentView = 'month';
let events = [];

// Initialize events data from template
try {
    events = {% if events_data %}{{ events_data | tojson | safe }}{% else %}[]{% endif %};
    // Ensure events is an array
    if (!Array.isArray(events)) {
        events = [];
    }
} catch (e) {
    console.error('Error loading events data:', e);
    events = [];
}

// Initialize calendar on page load
document.addEventListener('DOMContentLoaded', function() {
    updateCalendar();
    updateMonthDisplay();
});

function changeMonth(direction) {
    currentDate.setMonth(currentDate.getMonth() + direction);
    updateCalendar();
    updateMonthDisplay();
}

function updateMonthDisplay() {
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('currentMonth').textContent = 
        `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
}

function switchView(view) {
    currentView = view;
    
    // Hide all views
    document.getElementById('monthView').style.display = 'none';
    document.getElementById('weekView').style.display = 'none';
    document.getElementById('listView').style.display = 'none';
    
    // Show selected view
    document.getElementById(view + 'View').style.display = 'block';
    
    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById(view + 'ViewBtn').classList.add('active');
    
    // Update calendar content
    if (view === 'month') {
        updateCalendar();
    } else if (view === 'week') {
        updateWeekView();
    }
}

function updateCalendar() {
    if (currentView !== 'month') return;
    
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';
    
    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const today = new Date();
    
    for (let i = 0; i < 42; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        
        if (date.getMonth() !== currentDate.getMonth()) {
            dayElement.classList.add('other-month');
        }
        
        if (date.toDateString() === today.toDateString()) {
            dayElement.classList.add('today');
        }
        
        // Day number
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = date.getDate();
        dayElement.appendChild(dayNumber);
        
        // Events for this day
        const dayEvents = document.createElement('div');
        dayEvents.className = 'day-events';
        
        const dayEventsList = getEventsForDate(date);
        const maxVisible = 3;
        
        dayEventsList.slice(0, maxVisible).forEach(event => {
            const eventDot = document.createElement('div');
            eventDot.className = `event-dot ${event.event_type}`;
            eventDot.textContent = event.title;
            eventDot.onclick = (e) => {
                e.stopPropagation(); // Prevent day click
                showEventDetails(event);
            };
            dayEvents.appendChild(eventDot);
        });
        
        if (dayEventsList.length > maxVisible) {
            const moreEvents = document.createElement('div');
            moreEvents.className = 'more-events';
            moreEvents.textContent = `+${dayEventsList.length - maxVisible} more`;
            moreEvents.onclick = (e) => {
                e.stopPropagation(); // Prevent day click
                showDayEvents(date, dayEventsList);
            };
            dayEvents.appendChild(moreEvents);
        }
        
        dayElement.appendChild(dayEvents);
        
        // Make day clickable for adding events, but not if clicking on events
        dayElement.onclick = (e) => {
            if (e.target === dayElement || e.target === dayNumber || e.target === dayEvents) {
                addEventOnDate(date);
            }
        };
        
        grid.appendChild(dayElement);
    }
}

function updateWeekView() {
    if (currentView !== 'week') return;
    
    // Get week start (Sunday)
    const weekStart = new Date(currentDate);
    weekStart.setDate(currentDate.getDate() - currentDate.getDay());
    
    // Update week days header
    const weekDays = document.getElementById('weekDays');
    weekDays.innerHTML = '';
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    
    for (let i = 0; i < 7; i++) {
        const day = new Date(weekStart);
        day.setDate(weekStart.getDate() + i);
        
        const dayElement = document.createElement('div');
        dayElement.className = 'week-day';
        dayElement.innerHTML = `${dayNames[i]}<br><small>${day.getDate()}</small>`;
        weekDays.appendChild(dayElement);
    }
    
    // Update week grid
    const weekGrid = document.getElementById('weekGrid');
    weekGrid.innerHTML = '';
    
    // Time slots column
    const timeSlotsContainer = document.createElement('div');
    timeSlotsContainer.className = 'time-slots';
    
    for (let hour = 0; hour < 24; hour++) {
        const timeSlot = document.createElement('div');
        timeSlot.className = 'time-slot';
        timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
        timeSlotsContainer.appendChild(timeSlot);
    }
    
    weekGrid.appendChild(timeSlotsContainer);
    
    // Week events container
    const weekEvents = document.createElement('div');
    weekEvents.className = 'week-events';
    
    for (let i = 0; i < 7; i++) {
        const dayColumn = document.createElement('div');
        dayColumn.className = 'week-day-column';
        dayColumn.style.height = '1440px'; // 24 hours * 60px
        
        const day = new Date(weekStart);
        day.setDate(weekStart.getDate() + i);
        
        const dayEvents = getEventsForDate(day);
        dayEvents.forEach(event => {
            const eventElement = document.createElement('div');
            eventElement.className = 'week-event';
            eventElement.textContent = event.title;
            eventElement.onclick = () => showEventDetails(event);
            
            const startTime = new Date(event.start_time);
            const endTime = new Date(event.end_time);
            const top = (startTime.getHours() * 60 + startTime.getMinutes());
            const duration = (endTime - startTime) / (1000 * 60); // minutes
            
            eventElement.style.top = `${top}px`;
            eventElement.style.height = `${Math.max(duration, 30)}px`;
            
            dayColumn.appendChild(eventElement);
        });
        
        weekEvents.appendChild(dayColumn);
    }
    
    weekGrid.appendChild(weekEvents);
}

function getEventsForDate(date) {
    return events.filter(event => {
        const eventDate = new Date(event.start_time);
        return eventDate.toDateString() === date.toDateString();
    });
}

function showDayEvents(date, dayEvents) {
    // Show all events for a specific day in a modal
    const modal = new bootstrap.Modal(document.getElementById('eventModal'));
    const body = document.getElementById('eventModalBody');
    
    const dateStr = date.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    let html = `<h5>Events for ${dateStr}</h5><hr>`;
    
    if (dayEvents.length === 0) {
        html += '<p class="text-muted">No events scheduled for this day.</p>';
    } else {
        dayEvents.forEach(event => {
            const startTime = new Date(event.start_time);
            const endTime = new Date(event.end_time);
            html += `
                <div class="card mb-2">
                    <div class="card-body">
                        <h6 class="card-title">${event.title}</h6>
                        <p class="card-text text-muted">${event.description || 'No description'}</p>
                        <small class="text-muted">
                            ${startTime.toLocaleTimeString()} - ${endTime.toLocaleTimeString()}
                        </small>
                        <br>
                        <button class="btn btn-sm btn-primary mt-2" onclick="showEventDetails({id: ${event.id}})">
                            View Details
                        </button>
                    </div>
                </div>
            `;
        });
    }
    
    body.innerHTML = html;
    
    // Hide edit and delete buttons for day view
    document.getElementById('editEventBtn').style.display = 'none';
    document.getElementById('deleteEventBtn').style.display = 'none';
    
    modal.show();
}

function showEventDetails(event) {
    // If only ID is provided, find the full event object
    if (typeof event === 'object' && event.id && !event.title) {
        event = events.find(e => e.id === event.id);
        if (!event) {
            console.error('Event not found');
            return;
        }
    }
    
    const modal = new bootstrap.Modal(document.getElementById('eventModal'));
    const body = document.getElementById('eventModalBody');
    
    const startTime = new Date(event.start_time);
    const endTime = new Date(event.end_time);
    const priorityNames = {1: 'Very Low', 2: 'Low', 3: 'Normal', 4: 'High', 5: 'Very High'};
    
    body.innerHTML = `
        <h5>${event.title}</h5>
        <p class="text-muted">${event.description || 'No description'}</p>
        <hr>
        <div class="row">
            <div class="col-sm-6">
                <strong>Start:</strong><br>
                ${startTime.toLocaleString()}
            </div>
            <div class="col-sm-6">
                <strong>End:</strong><br>
                ${endTime.toLocaleString()}
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-sm-6">
                <strong>Type:</strong><br>
                <span class="badge bg-primary">${event.event_type}</span>
            </div>
            <div class="col-sm-6">
                <strong>Priority:</strong><br>
                <span class="badge bg-warning">${priorityNames[event.priority_level]}</span>
            </div>
        </div>
    `;
    
    // Show edit and delete buttons for individual events
    document.getElementById('editEventBtn').style.display = 'inline-block';
    document.getElementById('deleteEventBtn').style.display = 'inline-block';
    
    // Set up edit and delete buttons
    document.getElementById('editEventBtn').onclick = () => {
        window.location.href = `{{ url_for('main.edit_calendar_event', event_id=0) }}`.replace('0', event.id);
    };
    
    document.getElementById('deleteEventBtn').onclick = () => {
        if (confirm('Are you sure you want to delete this event?')) {
            fetch(`{{ url_for('main.delete_calendar_event', event_id=0) }}`.replace('0', event.id), { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(() => location.reload());
        }
    };
    
    modal.show();
}

function addEventOnDate(date) {
    const dateStr = date.toISOString().split('T')[0];
    window.location.href = `{{ url_for('main.add_calendar_event') }}?date=${dateStr}`;
}

function syncGoogleCalendar() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    // Show loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Syncing...';
    button.disabled = true;
    
    fetch('{{ url_for("main.sync_google_calendar") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            button.innerHTML = '<i class="fas fa-check me-1"></i>Synced!';
            button.classList.remove('btn-outline-success');
            button.classList.add('btn-success');
            
            // Reload page to show new events
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            // Show error
            button.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Error';
            button.classList.remove('btn-outline-success');
            button.classList.add('btn-danger');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('btn-danger');
                button.classList.add('btn-outline-success');
                button.disabled = false;
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Sync error:', error);
        button.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Error';
        button.classList.remove('btn-outline-success');
        button.classList.add('btn-danger');
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('btn-danger');
            button.classList.add('btn-outline-success');
            button.disabled = false;
        }, 2000);
    });
}

function resetTodayOptimization() {
    if (!confirm('Are you sure you want to reset today\'s AI optimization? This will remove all AI-generated reminders for today.')) {
        return;
    }
    
    fetch('{{ url_for("main.reset_today_optimization") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload(); // Refresh the page to show updated calendar
        } else {
            alert('Reset failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Reset failed: ' + error.message);
    });
}

function optimizeSchedule() {
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('optimizationModal'));
    modal.show();
    
    // Call AI optimization API
    fetch('{{ url_for("main.optimize_schedule") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        displayOptimizationResults(data);
    })
    .catch(error => {
        console.error('Error:', error);
        displayOptimizationError(error);
    });
}

function displayOptimizationResults(data) {
    const content = document.getElementById('optimizationContent');
    
    if (data.error) {
        content.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Error:</strong> ${data.error}
            </div>
        `;
        return;
    }
    
    let html = '<div class="optimization-results">';
    
    // Schedule changes
    if (data.schedule_changes && data.schedule_changes.length > 0) {
        html += `
            <h6><i class="fas fa-calendar-alt me-2"></i>Suggested Schedule Changes</h6>
            <div class="list-group mb-3">
        `;
        data.schedule_changes.forEach(change => {
            // Format the optimized time properly using the correct field names
            let suggestedTime = 'Invalid Date';
            try {
                // Use the optimized_start field which contains the time in HH:MM format
                if (change.optimized_start) {
                    suggestedTime = change.optimized_start;
                } else if (change.optimized_start_full) {
                    // If we have the full ISO date, parse it and format it
                    const optimalDate = new Date(change.optimized_start_full);
                    if (!isNaN(optimalDate.getTime())) {
                        suggestedTime = optimalDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }
                } else {
                    suggestedTime = 'Time not available';
                }
            } catch (e) {
                console.warn('Date parsing error:', e, change);
                suggestedTime = 'Error parsing time';
            }
            
            html += `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">Event Reschedule</h6>
                        <small class="text-muted">AI Suggestion</small>
                    </div>
                    <p class="mb-1">${change.event_title || 'Event'}</p>
                    <p class="mb-1">${change.reason}</p>
                    <small>Original time: ${change.original_start || 'Unknown'} → Suggested time: ${suggestedTime}</small>
                </div>
            `;
        });
        html += '</div>';
    }
    
    // New reminders
    if (data.new_reminders && data.new_reminders.length > 0) {
        html += `
            <h6><i class="fas fa-bell me-2"></i>Smart Reminders</h6>
            <div class="list-group mb-3">
        `;
        data.new_reminders.forEach(reminder => {
            const iconClass = reminder.type === 'water' ? 'fa-tint' : 
                            reminder.type === 'exercise' ? 'fa-dumbbell' : 
                            reminder.type === 'sleep' ? 'fa-bed' :
                            reminder.type === 'meal' ? 'fa-utensils' :
                            reminder.type === 'medication' ? 'fa-pills' : 'fa-bell';
            
            // Format the reminder time properly
            let reminderTime = 'Invalid Time';
            try {
                // Try multiple possible field names for time
                const timeValue = reminder.time || reminder.start_time || reminder.reminder_time;
                if (timeValue) {
                    const reminderDate = new Date(timeValue);
                    if (!isNaN(reminderDate.getTime())) {
                        reminderTime = reminderDate.toLocaleTimeString();
                    }
                }
            } catch (e) {
                console.warn('Reminder time parsing error:', e, reminder);
            }
            
            html += `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">
                            <i class="fas ${iconClass} me-2"></i>${reminder.type.charAt(0).toUpperCase() + reminder.type.slice(1)} Reminder
                        </h6>
                        <small>${reminderTime}</small>
                    </div>
                    <p class="mb-1">${reminder.message}</p>
                </div>
            `;
        });
        html += '</div>';
    }
    
    // Insights
    if (data.insights && data.insights.length > 0) {
        html += `
            <h6><i class="fas fa-lightbulb me-2"></i>AI Insights</h6>
            <ul class="list-unstyled">
        `;
        data.insights.forEach(insight => {
            html += `<li><i class="fas fa-check-circle text-success me-2"></i>${insight}</li>`;
        });
        html += '</ul>';
    }
    
    if (!data.schedule_changes?.length && !data.new_reminders?.length && !data.insights?.length) {
        html += `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Your schedule looks well-optimized! No immediate changes needed.
            </div>
        `;
    }
    
    html += '</div>';
    content.innerHTML = html;
}

function displayOptimizationError(error) {
    const content = document.getElementById('optimizationContent');
    content.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Error:</strong> Failed to optimize schedule. Please try again later.
        </div>
    `;
}
</script>
{% endblock %}
